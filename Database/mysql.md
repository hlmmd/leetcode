# mysql技术内幕

## MySQL体系结构和存储引擎

### 数据库和数据库实例

* 数据库：主要指文件，是文件的集合
* 数据库实例：Mysql数据库进程

mysql是单进程、多线程的数据库

Mysql启动后，先读取配置文件，如果没有配置文件，则会按照编译时的默认参数启动

### Mysql体系结构

Mysql由以下几部分组成

* 连接池组件
* 管理服务和工具组件
* SQL接口组件
* 查询分析器组件
* 优化器组件
* 缓冲组件
* 插件式存储引擎
* 物理文件

### Mysql存储引擎

#### InnoDB

面向在线事务处理（OLTP）

特点：支持事务，行锁设计、支持外键、非锁定读、多版本并发控制（MVCC，以获得高并发性）、四种隔离级别

InnoDB采用了聚集方式，每张表的存储都是按主键顺序进行存放的，如果没有显示定义主键，则生成一个6字节的ROWID，作为主键

#### MyISAM 存储引擎

不支持事务，表级锁，支持全文索引，面向OLAP

#### NDB

数据存放在内存中

#### Memory

数据存放在内存，使用哈希索引

### 连接Mysql

TCP/IP

连接时会检查一张权限视图，用来判断客户端IP是否允许连接到Mysql实例。

Unix套接字

主要用于本地连接

## Innodb存储引擎

InnoDB是事务安全的存储引擎，第一个完整支持ACID，行级锁、MVCC、外键、非锁定读。具有高性能、高可用、高可拓展性。

### 后台线程

Master Thread：核心线程，负责将缓冲池中的数据异步刷新到磁盘

IO Thread：使用AIO，提高数据库性能

Purge Thread： 事务提交后，所使用的undolog不再需要，使用PurgeThread来回收。

### 内存

#### 缓冲池

InnoDB是基于磁盘存储的，将其中的记录按照页的方式进行管理。使用缓冲技术来提高性能。

简单来说，缓冲池就是一块内存区域。数据库的修改，会首先修改缓冲池中的页，再以一定的刷新频率刷新到磁盘上。刷新使用checkpoint机制。

InnoDB使用innodb_buffer_pool_size来设置缓冲池的大小。

缓冲池中的数据页类型由索引页、数据页、undo页、插入缓冲等。

缓冲池通过LRU来管理页。并且加入了midpoint位置，即新读取到的页，并不会直接放入LRU列表的首部，而是放入midpoint位置，默认是5/8。

LRU前面部分的页成为热端，如果将新的页直接放入首部，那么很可能将常用的页从LRU列表中删除，而在下一次读取该页的时候，需要重新访问磁盘。InnoDB设置了一个参数，来表示一个页表读取到midpoint多少次后，才会被加入到LRU列表的热端。

压缩页：将原本16KB的页压缩为1-8KB。对于这些压缩过的页，使用unzip_LRU进行管理。unzip_LRU通过伙伴算法从缓冲池中分配内存。

## 